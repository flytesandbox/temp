name: CI and Deploy

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref (branch, tag, or SHA) to deploy/test"
        required: false
        default: "main"

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || github.ref }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Run unit tests
        run: python -m unittest tests/test_app.py

  deploy:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || github.ref }}

      - name: Validate and normalize deploy settings
        id: deploy_vars
        env:
          RAW_DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          RAW_DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          RAW_DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          RAW_DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
          RAW_DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          RAW_SERVICE_NAME: ${{ secrets.SERVICE_NAME }}
        run: |
          set -euo pipefail

          DEPLOY_HOST="$(printf '%s' "${RAW_DEPLOY_HOST:-}" | tr -d '\r\n')"
          DEPLOY_USER="$(printf '%s' "${RAW_DEPLOY_USER:-}" | tr -d '\r\n')"
          DEPLOY_PATH="$(printf '%s' "${RAW_DEPLOY_PATH:-}" | tr -d '\r\n')"
          DEPLOY_PORT="$(printf '%s' "${RAW_DEPLOY_PORT:-}" | tr -d '\r\n')"
          DEPLOY_SSH_KEY="${RAW_DEPLOY_SSH_KEY:-}"
          SERVICE_NAME="$(printf '%s' "${RAW_SERVICE_NAME:-}" | tr -d '\r\n')"

          if [ -z "$DEPLOY_HOST" ]; then
            echo "ERROR: required secret DEPLOY_HOST is empty." >&2
            exit 1
          fi
          if [ -z "$DEPLOY_USER" ]; then
            echo "ERROR: required secret DEPLOY_USER is empty." >&2
            exit 1
          fi
          if [ -z "$DEPLOY_PATH" ]; then
            echo "ERROR: required secret DEPLOY_PATH is empty." >&2
            exit 1
          fi
          if [ -z "$DEPLOY_SSH_KEY" ]; then
            echo "ERROR: required secret DEPLOY_SSH_KEY is empty." >&2
            exit 1
          fi

          if [ -z "$DEPLOY_PORT" ]; then
            DEPLOY_PORT="22"
          fi

          if [ -z "$SERVICE_NAME" ]; then
            SERVICE_NAME="monolith-task-tracker"
          fi

          echo "DEPLOY_HOST=$DEPLOY_HOST" >> "$GITHUB_ENV"
          echo "DEPLOY_USER=$DEPLOY_USER" >> "$GITHUB_ENV"
          echo "DEPLOY_PATH=$DEPLOY_PATH" >> "$GITHUB_ENV"
          echo "DEPLOY_PORT=$DEPLOY_PORT" >> "$GITHUB_ENV"
          echo "SERVICE_NAME=$SERVICE_NAME" >> "$GITHUB_ENV"

          {
            echo "DEPLOY_SSH_KEY<<EOF"
            printf '%s\n' "$DEPLOY_SSH_KEY"
            echo "EOF"
          } >> "$GITHUB_ENV"

          echo "Deploy target: ${DEPLOY_USER}@${DEPLOY_HOST}:${DEPLOY_PATH} (port ${DEPLOY_PORT}), service ${SERVICE_NAME}"

      - name: Prepare SSH key
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          printf '%s\n' "$DEPLOY_SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

      - name: Add server to known_hosts
        run: |
          set -euo pipefail
          ssh-keyscan -p "$DEPLOY_PORT" -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts

      - name: Sync repository to server with rsync
        run: |
          set -euo pipefail
          rsync -az --delete \
            --exclude '.git' \
            --exclude '.github' \
            --exclude '.venv' \
            --exclude '.env' \
            --exclude 'data/' \
            --exclude 'uploads/' \
            --exclude '*.db' \
            -e "ssh -p $DEPLOY_PORT" \
            ./ "$DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH/"

      - name: Restart and verify service
        run: |
          set -euo pipefail
          REMOTE="$DEPLOY_USER@$DEPLOY_HOST"

          ssh -p "$DEPLOY_PORT" "$REMOTE" "sudo systemctl restart '$SERVICE_NAME'"

          if ! ssh -p "$DEPLOY_PORT" "$REMOTE" "sudo systemctl is-active --quiet '$SERVICE_NAME'"; then
            echo "Service failed to restart or is not active: $SERVICE_NAME" >&2
            ssh -p "$DEPLOY_PORT" "$REMOTE" "sudo systemctl status '$SERVICE_NAME' --no-pager -l || true"
            ssh -p "$DEPLOY_PORT" "$REMOTE" "sudo journalctl -u '$SERVICE_NAME' -n 200 --no-pager || true"
            exit 1
          fi

          ssh -p "$DEPLOY_PORT" "$REMOTE" "sudo systemctl status '$SERVICE_NAME' --no-pager -l"
